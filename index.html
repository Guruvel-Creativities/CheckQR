<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 15px; background: #f0f2f5; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        video { width: 100%; max-width: 500px; border-radius: 12px; background: #000; display: block; margin: 10px 0; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #007bff; color: white; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #007bff; color: white; }
        .status-bar { padding: 8px; font-size: 0.9em; border-radius: 5px; margin-bottom: 10px; }
        .error { background: #ffe3e3; color: #d32f2f; }
        .success { background: #e3ffe3; color: #2e7d32; }
    </style>
</head>
<body>

    <div class="card">
        <h2>QR Manager</h2>
        <div class="btn-group">
            <button onclick="generatePDF()">Create PDF</button>
            <button onclick="startScanner()" style="background: #28a745;">Start Back Cam</button>
        </div>
        <div id="status" class="status-bar">Ready to scan...</div>
        <video id="video" playsinline></video>
    </div>

    <div class="card">
        <h3>Scanned History</h3>
        <table id="scanTable">
            <thead><tr><th>Time</th><th>Data</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

<script>
let scannedData = JSON.parse(localStorage.getItem('scannedQRs') || '[]');
const videoElement = document.getElementById('video');
const statusDiv = document.getElementById('status');
let barcodeDetector;

function updateTable() {
    const tbody = document.querySelector('#scanTable tbody');
    tbody.innerHTML = scannedData.slice().reverse().map(entry => 
        `<tr><td>${entry.time}</td><td><code>${entry.data}</code></td></tr>`
    ).join('');
    localStorage.setItem('scannedQRs', JSON.stringify(scannedData));
}

async function startScanner() {
    try {
        statusDiv.className = "status-bar";
        statusDiv.innerText = "Requesting camera...";

        // 1. Load MediaPipe
        const vision = await imgly?.tasksVision || window["tasks-vision"];
        const filesetResolver = await vision.FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );
        
        barcodeDetector = await vision.BarcodeDetector.createFromOptions(filesetResolver, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-assets/barcode_detector.tflite`,
                delegate: "GPU"
            },
            runningMode: "VIDEO"
        });

        // 2. Start Video with constraints
        const constraints = {
            video: { 
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        videoElement.onloadedmetadata = () => {
            videoElement.play();
            statusDiv.className = "status-bar success";
            statusDiv.innerText = "Scanner Active";
            predictWebcam();
        };

    } catch (err) {
        statusDiv.className = "status-bar error";
        statusDiv.innerText = "Error: " + err.message;
        console.error(err);
    }
}

async function predictWebcam() {
    if (videoElement.paused || videoElement.ended) return;

    if (videoElement.currentTime !== lastVideoTime) {
        lastVideoTime = videoElement.currentTime;
        const result = await barcodeDetector.detectForVideo(videoElement, performance.now());
        
        if (result.length > 0) {
            const code = result[0].rawValue;
            if (!scannedData.some(d => d.data === code)) {
                scannedData.push({ data: code, time: new Date().toLocaleTimeString() });
                updateTable();
                // Visual Ping
                videoElement.style.filter = "brightness(1.5)";
                setTimeout(() => videoElement.style.filter = "none", 150);
            }
        }
    }
    requestAnimationFrame(predictWebcam);
}
let lastVideoTime = -1;

async function generatePDF() {
    const qty = prompt("Quantity:", "5");
    if (!qty) return;
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'mm', format: [100, 100] });
    
    for (let i = 1; i <= qty; i++) {
        const data = `QR-${i}-${Math.random().toString(36).substr(2, 5)}`;
        const canvas = document.createElement('canvas');
        await QRCode.toCanvas(canvas, data);
        pdf.addImage(canvas.toDataURL(), 'PNG', 10, 10, 40, 40);
        pdf.text(data, 10, 55);
        if (i < qty) pdf.addPage();
    }
    pdf.save('qrs.pdf');
}

updateTable();
</script>
</body>
</html>
