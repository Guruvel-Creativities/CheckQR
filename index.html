<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 15px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        .btn-row { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; }
        #genBtn { background: #6c757d; }
        #scanBtn { background: #28a745; }
        #video-container { width: 100%; aspect-ratio: 1; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .status { padding: 12px; border-radius: 8px; background: #eee; text-align: center; margin-bottom: 15px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="card">
    <div class="btn-row">
        <button id="genBtn">1. Generate PDF</button>
        <button id="scanBtn">2. Start Back Cam</button>
    </div>

    <div id="status" class="status">Initializing...</div>
    
    <div id="video-container">
        <video id="video" playsinline></video>
    </div>

    <table id="scanTable">
        <thead><tr><th>Time</th><th>Data</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script type="module">
    // Using an 'import' within a type="module" script is required for MediaPipe
    import { BarcodeDetector, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const scanBtn = document.getElementById('scanBtn');
    const genBtn = document.getElementById('genBtn');
    
    let detector;
    let lastTime = -1;
    let history = JSON.parse(localStorage.getItem('scannedQRs') || '[]');

    // Setup UI
    status.innerText = "Library Loaded. Ready to Scan.";

    // --- PDF LOGIC ---
    genBtn.onclick = async () => {
        const qty = prompt("How many QRs?", "3");
        if (!qty) return;
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        for (let i = 1; i <= parseInt(qty); i++) {
            const data = "ID-" + Math.floor(Math.random() * 10000);
            const canvas = document.createElement('canvas');
            await QRCode.toCanvas(canvas, data);
            pdf.addImage(canvas.toDataURL(), 'PNG', 20, 20, 40, 40);
            pdf.text(data, 20, 70);
            if (i < qty) pdf.addPage();
        }
        pdf.save("qrs.pdf");
    };

    // --- SCANNER LOGIC ---
    scanBtn.onclick = async () => {
        try {
            status.innerText = "Starting Camera...";
            
            // 1. Setup MediaPipe
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            detector = await BarcodeDetector.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/barcode_detector.tflite",
                    delegate: "GPU"
                },
                runningMode: "VIDEO"
            });

            // 2. Setup Camera
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });

            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                status.innerText = "Scanning Active (Back Cam)";
                status.style.background = "#d4edda";
                requestAnimationFrame(loop);
            };
        } catch (err) {
            status.innerText = "Error: " + err.message;
            status.style.background = "#f8d7da";
        }
    };

    async function loop() {
        if (video.currentTime !== lastTime) {
            lastTime = video.currentTime;
            if (detector) {
                const res = await detector.detectForVideo(video, performance.now());
                if (res.length > 0) {
                    const val = res[0].rawValue;
                    if (history.length === 0 || history[0].data !== val) {
                        history.unshift({ data: val, time: new Date().toLocaleTimeString() });
                        localStorage.setItem('scannedQRs', JSON.stringify(history));
                        renderTable();
                    }
                }
            }
        }
        requestAnimationFrame(loop);
    }

    function renderTable() {
        document.querySelector('#scanTable tbody').innerHTML = history.map(h => 
            `<tr><td>${h.time}</td><td>${h.data}</td></tr>`
        ).join('');
    }

    renderTable();
</script>

</body>
</html>
