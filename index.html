<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 15px; background: #f4f4f9; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        .btn-row { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #genBtn { background: #6c757d; color: white; }
        #scanBtn { background: #28a745; color: white; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        #video-container { width: 100%; aspect-ratio: 1; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .status { padding: 12px; border-radius: 8px; background: #eee; text-align: center; margin-bottom: 15px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { font-size: 12px; color: #888; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="card">
    <div class="btn-row">
        <button id="genBtn">Generate PDF</button>
        <button id="scanBtn">Start Back Cam</button>
    </div>

    <div id="status" class="status">Ready. Please grant camera access.</div>
    
    <div id="video-container">
        <video id="video" playsinline></video>
    </div>

    <table id="scanTable">
        <thead><tr><th>Time</th><th>Data</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script type="module">
    // This import requires type="module" in the script tag
    import { BarcodeDetector, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const genBtn = document.getElementById('genBtn');
    const scanBtn = document.getElementById('scanBtn');
    
    let detector;
    let lastTime = -1;
    let scannedList = JSON.parse(localStorage.getItem('scannedQRs') || '[]');

    // --- 1. PDF GENERATION LOGIC ---
    genBtn.addEventListener('click', async () => {
        const qty = prompt("How many QRs?", "3");
        if (!qty) return;

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        for (let i = 1; i <= parseInt(qty); i++) {
            const data = `QR-ID-${Math.floor(Math.random() * 9000)}`;
            const canvas = document.createElement('canvas');
            await QRCode.toCanvas(canvas, data);
            pdf.addImage(canvas.toDataURL(), 'PNG', 20, 20, 40, 40);
            pdf.text(`Code: ${data}`, 20, 70);
            if (i < qty) pdf.addPage();
        }
        pdf.save("qrs.pdf");
    });

    // --- 2. SCANNER LOGIC ---
    scanBtn.addEventListener('click', async () => {
        try {
            status.innerText = "Initializing AI...";
            
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            
            detector = await BarcodeDetector.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/barcode_detector.tflite",
                    delegate: "GPU"
                },
                runningMode: "VIDEO"
            });

            status.innerText = "Starting Back Camera...";

            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: "environment", // BACK CAMERA
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });

            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                status.innerText = "Scanning Active";
                status.style.background = "#d4edda";
                requestAnimationFrame(detectionLoop);
            };

        } catch (err) {
            status.innerText = "Error: " + err.message;
            status.style.background = "#f8d7da";
        }
    });

    async function detectionLoop() {
        if (video.currentTime !== lastTime) {
            lastTime = video.currentTime;
            if (detector) {
                const results = await detector.detectForVideo(video, performance.now());
                if (results.length > 0) {
                    const rawData = results[0].rawValue;
                    
                    // Duplicate check
                    if (scannedList.length === 0 || scannedList[0].data !== rawData) {
                        const newEntry = { data: rawData, time: new Date().toLocaleTimeString() };
                        scannedList.unshift(newEntry); // Newest at top
                        localStorage.setItem('scannedQRs', JSON.stringify(scannedList));
                        renderTable();
                        
                        // Haptic/Visual feedback
                        status.innerText = "Scanned: " + rawData;
                        setTimeout(() => status.innerText = "Scanning Active", 1500);
                    }
                }
            }
        }
        requestAnimationFrame(detectionLoop);
    }

    function renderTable() {
        const tbody = document.querySelector('#scanTable tbody');
        tbody.innerHTML = scannedList.map(item => 
            `<tr><td>${item.time}</td><td><code>${item.data}</code></td></tr>`
        ).join('');
    }

    // Initial load
    renderTable();
</script>

</body>
</html>
