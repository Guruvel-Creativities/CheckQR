<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #007bff; color: white; }
        #video-container { width: 100%; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        video { width: 100%; display: block; }
        .status { padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #eee; font-size: 14px; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-group">
        <button onclick="generatePDF()">Generate PDF</button>
        <button onclick="startScanner()" style="background:#28a745">Start Back Cam</button>
    </div>

    <div id="status" class="status">Waiting to start...</div>
    
    <div id="video-container">
        <video id="video" playsinline></video>
    </div>

    <table id="scanTable">
        <thead><tr><th>Time</th><th>Data</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
let scannedData = JSON.parse(localStorage.getItem('scannedQRs') || '[]');
let barcodeDetector;
let lastVideoTime = -1;
const videoElement = document.getElementById('video');
const statusDiv = document.getElementById('status');

function updateTable() {
    const tbody = document.querySelector('#scanTable tbody');
    tbody.innerHTML = scannedData.slice().reverse().map(entry => 
        `<tr><td>${entry.time}</td><td>${entry.data}</td></tr>`
    ).join('');
    localStorage.setItem('scannedQRs', JSON.stringify(scannedData));
}

async function startScanner() {
    try {
        statusDiv.innerText = "Initializing AI...";

        // FIX: Specifically checking for the MediaPipe library object
        const vision = window.tasksVision || window["tasks-vision"];
        if (!vision) {
            throw new Error("MediaPipe Library not loaded yet. Please wait 2 seconds and try again.");
        }

        const filesetResolver = await vision.FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );
        
        barcodeDetector = await vision.BarcodeDetector.createFromOptions(filesetResolver, {
            baseOptions: {
                modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/barcode_detector.tflite",
                delegate: "GPU"
            },
            runningMode: "VIDEO"
        });

        statusDiv.innerText = "Opening Back Camera...";

        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: "environment",
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        });

        videoElement.srcObject = stream;
        videoElement.onloadedmetadata = () => {
            videoElement.play();
            statusDiv.innerText = "Scanning...";
            predictWebcam();
        };

    } catch (err) {
        statusDiv.innerText = "Error: " + err.message;
        console.error("Scanner Error:", err);
    }
}

async function predictWebcam() {
    if (videoElement.currentTime !== lastVideoTime) {
        lastVideoTime = videoElement.currentTime;
        if (barcodeDetector) {
            const detections = await barcodeDetector.detectForVideo(videoElement, performance.now());
            if (detections.length > 0) {
                const code = detections[0].rawValue;
                if (scannedData.length === 0 || scannedData[scannedData.length - 1].data !== code) {
                    scannedData.push({ data: code, time: new Date().toLocaleTimeString() });
                    updateTable();
                }
            }
        }
    }
    requestAnimationFrame(predictWebcam);
}

async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const canvas = document.createElement('canvas');
    const data = "TEST-123";
    await QRCode.toCanvas(canvas, data);
    pdf.addImage(canvas.toDataURL(), 'PNG', 10, 10, 50, 50);
    pdf.text("Sample QR: " + data, 10, 70);
    pdf.save("test.pdf");
}

updateTable();
</script>
</body>
</html>
