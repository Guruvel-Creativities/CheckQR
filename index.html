<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR PDF Generator & Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 800px; margin: 0 auto; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        button { padding: 10px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        video { width: 100%; max-width: 400px; border-radius: 8px; background: #eee; transform: scaleX(1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f4f4f4; }
        .status { color: #666; font-style: italic; }
    </style>
</head>
<body>

    <h2>QR PDF Generator & Scanner</h2>

    <div class="controls">
        <button onclick="generatePDF()">1. Generate QR PDF</button>
        <button onclick="startScanner()">2. Start Back Camera Scan</button>
    </div>

    <p id="loadingStatus" class="status">Scanner ready...</p>
    <video id="video" autoplay playsinline></video>

    <h3>Scanned QR Data</h3>
    <table id="scanTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>QR Content</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
// --- Data Management ---
let scannedData = JSON.parse(localStorage.getItem('scannedQRs') || '[]');

function updateTable() {
    const tbody = document.querySelector('#scanTable tbody');
    tbody.innerHTML = '';
    // Show newest first
    [...scannedData].reverse().forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${entry.time}</td><td><code>${entry.data}</code></td>`;
        tbody.appendChild(row);
    });
    localStorage.setItem('scannedQRs', JSON.stringify(scannedData));
}

// Initial load
updateTable();

// --- PDF Generation ---
async function generatePDF() {
    let qty = parseInt(prompt("How many QR codes to generate?", "10"));
    if (isNaN(qty) || qty <= 0) return;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'mm', format: [100, 150] }); // Portrait Label

    const qrSize = 25; 
    const margin = 5;
    const pageWidth = 100;
    const pageHeight = 150;

    let x = margin;
    let y = margin;

    for (let i = 1; i <= qty; i++) {
        let qrData = `ID-${String(i).padStart(4,'0')}`;
        
        // Create off-screen canvas for QR
        const canvas = document.createElement('canvas');
        await QRCode.toCanvas(canvas, qrData, { width: 200, margin: 2 });
        const imgData = canvas.toDataURL("image/png");

        pdf.addImage(imgData, 'PNG', x, y, qrSize, qrSize);
        pdf.setFontSize(8);
        pdf.text(qrData, x + (qrSize/2), y + qrSize + 3, { align: 'center' });

        x += qrSize + margin;
        
        // Wrap to next row
        if (x + qrSize > pageWidth) {
            x = margin;
            y += qrSize + margin + 5;
        }

        // New page if out of space
        if (y + qrSize + margin > pageHeight && i < qty) {
            pdf.addPage();
            x = margin;
            y = margin;
        }
    }

    pdf.save('bulk_qr_codes.pdf');
}

// --- MediaPipe QR Scanner ---
let barcodeDetector;
const videoElement = document.getElementById('video');
const statusText = document.getElementById('loadingStatus');

async function startScanner() {
    try {
        statusText.innerText = "Initializing Camera & AI...";
        
        // 1. Setup MediaPipe Vision
        const vision = await imgly.tasksVision; // Note: In CDN version, usually accessed via window.FilesetResolver
        const { ImageClassifier, BarcodeDetector, FilesetResolver } = window.createMediaPipeSolutions; 
        
        // Proper MediaPipe 0.10+ Initialization
        const visionTasks = await window.createMediaPipeSolutions.FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );

        barcodeDetector = await window.createMediaPipeSolutions.BarcodeDetector.createFromOptions(visionTasks, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-assets/barcode_detector.tflite`,
                delegate: "GPU"
            },
            runningMode: "VIDEO"
        });

        // 2. Request BACK CAMERA
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        videoElement.srcObject = stream;
        statusText.innerText = "Scanner Active - Point at a QR Code";

        // 3. Detection Loop
        videoElement.addEventListener('loadeddata', predictWebcam);

    } catch (err) {
        console.error(err);
        statusText.innerText = "Error: " + err.message;
        alert("Camera Error: Ensure you are on HTTPS and granted permissions.");
    }
}

let lastVideoTime = -1;
async function predictWebcam() {
    let startTimeMs = performance.now();
    
    if (videoElement.currentTime !== lastVideoTime) {
        lastVideoTime = videoElement.currentTime;
        const detections = await barcodeDetector.detectForVideo(videoElement, startTimeMs);
        
        if (detections.length > 0) {
            const foundData = detections[0].rawValue;
            
            // Check if this is a new scan (not in the last 2 seconds)
            const alreadyExists = scannedData.some(item => item.data === foundData);
            
            if (!alreadyExists) {
                const newEntry = {
                    data: foundData,
                    time: new Date().toLocaleTimeString()
                };
                scannedData.push(newEntry);
                updateTable();
                
                // Visual feedback
                videoElement.style.outline = "5px solid #28a745";
                setTimeout(() => videoElement.style.outline = "none", 500);
            }
        }
    }
    requestAnimationFrame(predictWebcam);
}
</script>

<script>
    window.createMediaPipeSolutions = window["tasks-vision"];
</script>

</body>
</html>
